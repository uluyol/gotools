#!/usr/bin/env bash
CFGDIR="$HOME/.config/backme"
KEYFILE="$CFGDIR/key"

if [[ $# != 2 ]]; then
	printf "Usage: %s [ chunkdir ] [ destdir ]\n" "$0"
	exit 1
fi

chunkdir=$1
destdir=$2

if [[ ! -d $1 ]]; then
	printf "error: chunkdir must be a directory\n" >&2
	exit 1
fi

if [[ ! -d $2 ]]; then
	printf "error: destdir must be a directory\n" >&2
	exit 1
fi

#untar=(bsdtar -xf - --no-same-owner)
#untar=(cpio -idmv --insecure)
untar=(cat)
z=(lz4 -d)
decrypt=(openssl aes-128-cbc -d -kfile "$KEYFILE")

corrupt=0
printf "verifying backup...\n"
chunks=()
for checksum in "$chunkdir"/*.sha256; do
	chunk="${checksum%.sha256}"
	chunks+=("$chunk")
	#newsum=$(shasum -a 256 <"$chunk" | awk '{ print $1; }')
	#oldsum=$(<"$checksum")
	#if [[ $newsum != $oldsum ]]; then
	#	printf "%s has been corrupted\n"
	#	corrupt=1
	#fi
done
if [[ $corrupt != 0 ]]; then
	exit 2
fi

base="${chunks%.*}"
ordered=()
for ((i=0; i < ${#chunks[@]}; i++)); do
	ordered+=("$base.$i")
done
printf "extracting backup to %s...\n" "$destdir"
printf "%s\n" "${ordered[@]}"
#cat "${ordered[@]}" | "${decrypt[@]}" | "${z[@]}" | "${untar[@]}" >back.cpio

