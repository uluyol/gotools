#!/usr/bin/env bash

CFGDIR="$HOME/.config/backme"
KEYFILE="$CFGDIR/key"
BACKUPLIST="$CFGDIR/dirlist"
TSTAMP="$CFGDIR/timestamp.drive"
FILELIST="$CFGDIR/filelist.drive"

runrdup=(rdup -m -M "$TSTAMP" "$FILELIST")
trans=(rdup-tr -Ocpio)
z=(lz4)
encrypt=(openssl aes-128-cbc -e -kfile "$KEYFILE")
upload=(drive upload -s -p 0Bwo0w3lvQN52flpIWWdWWkhCVTlYdzR2UjV0UE9YNUJWRWY5TmJwWmg4QVRJNVVpLXZseVk -t)

if [[ ! -d "$CFGDIR" ]]; then
	mkdir -p "$CFGDIR"
fi

if [[ ! -f "$BACKUPLIST" ]]; then
	printf "Must create directory backup list file %s\n" "$BACKUPLIST"
	exit 1
fi

if [[ ! -f "$KEYFILE" ]]; then
	printf "Must create encryption keyfile %s\n" "$KEYFILE"
	exit 1
fi

IFS=$'\n'
dirs=($(<"$BACKUPLIST"))
unset IFS

"${runrdup[@]}" "${dirs[@]}" | "${trans[@]}" | "${z[@]}" | "${encrypt[@]}" | "${upload[@]}" "$USER.$(date +%Y%m%d).cpio.lz4.enc"
touch "$TSTAMP"

